<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OLT Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin-top: 20px;
        }
        .olt-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 10px;
            width: calc(33% - 20px);
            min-width: 250px;
        }
        .olt-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }
        .status.online {
            background-color: #2ecc71;
            color: #fff;
        }
        .status.offline {
            background-color: #e74c3c;
            color: #fff;
        }
        .ip-address {
            color: #7f8c8d;
            margin-top: 5px;
        }
        .last-checked {
            font-size: 0.9em;
            color: #95a5a6;
            margin-top: 10px;
        }
        .chart-container {
            margin-top: 20px;
            height: 200px;
        }
        #log {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
            height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #ecf0f1;
        }
        .log-entry.error {
            color: #e74c3c;
        }
        .log-entry.info {
            color: #3498db;
        }
        .log-entry.warning {
            color: #f39c12;
        }
    </style>
</head>
<body>
    <h1>OLT Monitor Dashboard</h1>
    <div class="dashboard" id="dashboard"></div>
    <div id="log"></div>

    <script>
        const API_URL = 'http://localhost:3000/api/olts';
        const UPDATE_INTERVAL = 60000; // 1 minute

        function createOLTCard(olt) {
            const card = document.createElement('div');
            card.className = 'olt-card';
            card.setAttribute('data-ip', olt.ip);  
            card.innerHTML = `
                <div class="olt-name">${olt.name}</div>
                <div class="status">Checking...</div>
                <div class="ip-address">${olt.ip}</div>
                <div class="last-checked">Last checked: N/A</div>
                <div class="chart-container">
                    <canvas id="chart-${olt.ip.replace(/\./g, '-')}"></canvas>
                </div>
            `;
            return card;
        }

        function updateOLTStatus(oltStatus) {
            const oltCard = document.querySelector(`.olt-card[data-ip="${oltStatus.ip}"]`);
            if (oltCard) {
                const statusElement = oltCard.querySelector('.status');
                statusElement.textContent = oltStatus.status ? 'Online' : 'Offline';
                statusElement.className = `status ${oltStatus.status ? 'online' : 'offline'}`;
                oltCard.querySelector('.last-checked').textContent = `Last checked: ${new Date(oltStatus.last_checked).toLocaleTimeString()}`;
            }
        }

        function initializeChart(oltIP) {
            const ctx = document.getElementById(`chart-${oltIP.replace(/\./g, '-')}`).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Response Time (ms)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateChart(chart, responseTime, timestamp) {
            chart.data.labels.push(new Date(timestamp).toLocaleTimeString());
            chart.data.datasets[0].data.push(responseTime);
            
            if (chart.data.labels.length > 10) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            
            chart.update();
        }

        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logContainer.insertBefore(logEntry, logContainer.firstChild);
        }

        async function fetchOLTStatus() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                logMessage(`Error fetching OLT status: ${error.message}`, 'error');
                return [];
            }
        }

        function updateDashboard(oltStatuses) {
            oltStatuses.forEach
            (status => {
                updateOLTStatus(status);
                const chart = charts[status.ip];
                if (chart) {
                    updateChart(chart, status.response_time, status.last_checked);
                }
                
                if (!status.status) {
                    logMessage(`Issue detected with ${status.name} (${status.ip}). Please check immediately.`, 'error');
                } else {
                    logMessage(`${status.name} (${status.ip}): Responding to ping`, 'info');
                }
            });
        }

        const charts = {};

        async function monitorOLTs() {
            const dashboard = document.getElementById('dashboard');
            
            // Initial load
            const initialStatus = await fetchOLTStatus();
            initialStatus.forEach(olt => {
                const oltCard = createOLTCard(olt);
                dashboard.appendChild(oltCard);
                charts[olt.ip] = initializeChart(olt.ip);
            });

            // Periodic updates
            setInterval(async () => {
                const oltStatuses = await fetchOLTStatus();
                updateDashboard(oltStatuses);
            }, UPDATE_INTERVAL);
        }

        document.addEventListener('DOMContentLoaded', monitorOLTs);
    
    </script>
</body>
</html>
